<!DOCTYPE html>

<html>
<head>
  <title>user.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>user.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* Copyright (c) 2012-2014 Richard Rodger, MIT License */</span>
<span class="hljs-meta">'use strict'</span>


<span class="hljs-keyword">var</span> Crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>)

<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>)
<span class="hljs-keyword">var</span> Uuid = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-uuid'</span>)

<span class="hljs-keyword">var</span> Eraro = <span class="hljs-built_in">require</span>(<span class="hljs-string">'eraro'</span>)(
  {
    package: <span class="hljs-string">'seneca-user'</span>
  }
)</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>WARNING: this plugin is for <em>internal</em> use, DO NOT expose via an API.
See the seneca-auth plugin for an example of an API that uses this plugin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">user</span> (<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>

  <span class="hljs-keyword">var</span> user_canon = <span class="hljs-string">'sys/user'</span>
  <span class="hljs-keyword">var</span> login_canon = <span class="hljs-string">'sys/login'</span>
  <span class="hljs-keyword">var</span> reset_canon = <span class="hljs-string">'sys/reset'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h1 id="plugin-options-">Plugin options.</h1>
<p>These are the defaults. You can override using the <em>options</em> argument.
Example: <code>seneca.use(&quot;user&quot;,{mustrepeat:true})</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> default_options = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./default-options.json'</span>)

  options = seneca.util.deepextend(default_options, options)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>You can change the <em>role</em> value for the plugin patterns.
Use this when you want to load multiple versions of the plugin
and expose them via different patterns.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> role = options.role</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h1 id="action-patterns">Action patterns</h1>
<p>These define the pattern interface for this plugin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">conditionalExtend</span> (<span class="hljs-params">user, args</span>) </span>{
    <span class="hljs-keyword">var</span> extra = _.omit(args, options.updateUser.omit)
    _.map(extra, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">val, key</span>) </span>{
      <span class="hljs-keyword">if</span> (!key.match(<span class="hljs-regexp">/\$/</span>)) {
        user[key] = val
      }
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3 id="encrypt-a-plain-text-password-string">Encrypt a plain text password string</h3>
<p>Pattern: _<strong>role</strong>:user, <strong>cmd</strong>:encrypt<em>password</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({
    role: role,
    cmd: <span class="hljs-string">'encrypt_password'</span>,

    password: {type: <span class="hljs-string">'string$'</span>}, <span class="hljs-comment">// password plain text string</span>
    repeat: {type: <span class="hljs-string">'string$'</span>} <span class="hljs-comment">// password plain text string, repeated</span>
  }, cmd_encrypt_password)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3 id="verify-a-password-string">Verify a password string</h3>
<p>Pattern: _<strong>role</strong>:user, <strong>cmd</strong>:verify<em>password</em>
Has the user entered the correct password?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({
    role: role,
    cmd: <span class="hljs-string">'verify_password'</span>,

    proposed: {required$: <span class="hljs-literal">true</span>, string$: <span class="hljs-literal">true</span>},
    pass: {required$: <span class="hljs-literal">true</span>, string$: <span class="hljs-literal">true</span>},
    salt: {required$: <span class="hljs-literal">true</span>, string$: <span class="hljs-literal">true</span>}
  }, cmd_verify_password)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3 id="change-password">Change password</h3>
<p>Pattern: _<strong>role</strong>:user, <strong>cmd</strong>:change<em>password</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({
    role: role,
    cmd: <span class="hljs-string">'change_password'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>identify user, various options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    atleastone$: [<span class="hljs-string">'nick'</span>, <span class="hljs-string">'email'</span>, <span class="hljs-string">'user'</span>, <span class="hljs-string">'username'</span>],
    nick: {string$: <span class="hljs-literal">true</span>},
    email: {string$: <span class="hljs-literal">true</span>},
    username: {string$: <span class="hljs-literal">true</span>},
    user: {type$: [<span class="hljs-string">'object'</span>, <span class="hljs-string">'string'</span>]},

    password: {string$: <span class="hljs-literal">true</span>, required$: <span class="hljs-literal">true</span>}, <span class="hljs-comment">// new password plain text string</span>
    repeat: {string$: <span class="hljs-literal">true</span>}                 <span class="hljs-comment">// new password plain text string, repeated</span>
  }, resolve_user(cmd_change_password, <span class="hljs-literal">true</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3 id="register-a-new-user">Register a new user</h3>
<p>Pattern: <em><strong>role</strong>:user, <strong>cmd</strong>:register</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({
    role: role,
    cmd: <span class="hljs-string">'register'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>identify user, various options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    atleastone$: [<span class="hljs-string">'nick'</span>, <span class="hljs-string">'email'</span>, <span class="hljs-string">'username'</span>],
    nick: {string$: <span class="hljs-literal">true</span>},
    email: {string$: <span class="hljs-literal">true</span>},
    username: {string$: <span class="hljs-literal">true</span>},

    password: {string$: <span class="hljs-literal">true</span>},  <span class="hljs-comment">// password plain text string</span>
    repeat: {string$: <span class="hljs-literal">true</span>},  <span class="hljs-comment">// password plain text string, repeated</span>

    name: {string$: <span class="hljs-literal">true</span>},  <span class="hljs-comment">// full name, as one string</span>
    active: {boolean$: <span class="hljs-literal">true</span>}, <span class="hljs-comment">// is user active?</span>

    confirm: {boolean$: <span class="hljs-literal">true</span>} <span class="hljs-comment">// is user confirmed?</span>
  }, cmd_register)</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h3 id="login-a-user">Login a user</h3>
<p>Pattern: <em><strong>role</strong>:user, <strong>cmd</strong>:login</em>
Creates an entry in <em>sys/login</em> and generates a login token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({
    role: role,
    cmd: <span class="hljs-string">'login'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>identify user, various options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    atleastone$: [<span class="hljs-string">'nick'</span>, <span class="hljs-string">'email'</span>, <span class="hljs-string">'user'</span>, <span class="hljs-string">'username'</span>],
    nick: {string$: <span class="hljs-literal">true</span>},
    email: {string$: <span class="hljs-literal">true</span>},
    username: {string$: <span class="hljs-literal">true</span>},
    user: {object$: <span class="hljs-literal">true</span>},

    password: {string$: <span class="hljs-literal">true</span>}, <span class="hljs-comment">// password plain text</span>
    auto: {boolean$: <span class="hljs-literal">true</span>} <span class="hljs-comment">// login without password</span>

  }, resolve_user(cmd_login, <span class="hljs-literal">false</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h3 id="confirm-user">Confirm user</h3>
<p>Pattern: <em><strong>role</strong>:user, <strong>cmd</strong>:confirm</em>
Use confirmation code, provided to user by email (say), to confirm registration.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({
    role: role,
    cmd: <span class="hljs-string">'confirm'</span>,

    code: {string$: <span class="hljs-literal">true</span>, required$: <span class="hljs-literal">true</span>} <span class="hljs-comment">// confirmation code</span>
  }, cmd_confirm)</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h3 id="authorize-user">Authorize user</h3>
<p>Pattern: <em><strong>role</strong>:user, <strong>cmd</strong>:auth</em>
Validates that the token exists and is active</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({
    role: role,
    cmd: <span class="hljs-string">'auth'</span>,

    token: {required$: <span class="hljs-literal">true</span>, string$: <span class="hljs-literal">true</span>} <span class="hljs-comment">// login token</span>
  }, cmd_auth)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h3 id="logout-user">Logout user</h3>
<p>Pattern: <em><strong>role</strong>:user, <strong>cmd</strong>:logout</em>
Mark token record in <em>sys/login</em> as inactive</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({
    role: role,
    cmd: <span class="hljs-string">'logout'</span>,

    token: {required$: <span class="hljs-literal">true</span>, string$: <span class="hljs-literal">true</span>} <span class="hljs-comment">// login token</span>
  }, cmd_logout)</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h3 id="clean-user-data">Clean user data</h3>
<p>Pattern: <em><strong>role</strong>:user, <strong>cmd</strong>:clean</em>
Remove sensitive data fields such as password hash.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({
    role: role,
    cmd: <span class="hljs-string">'clean'</span>,

    user: {required$: <span class="hljs-literal">true</span>, entity$: user_canon} <span class="hljs-comment">// sys/user entity</span>
  }, cmd_clean)</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h3 id="load-user-based-on-a-query-">Load user based on a query.</h3>
<p>Required by external seneca plugins such as seneca-auth
Pattern: _<strong>role</strong>:user, <strong>cmd</strong>:load<em>user</em>
Returns an entity based on a query</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add(
    {
      role: role,
      get: <span class="hljs-string">'user'</span>
    },
    cmd_load_user
  )</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h3 id="create-a-password-reset-entry">Create a password reset entry</h3>
<p>Pattern: _<strong>role</strong>:user, <strong>cmd</strong>:create<em>reset</em>
Create an entry in <em>sys/reset</em> that provides a reset token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({role: role, cmd: <span class="hljs-string">'create_reset'</span>},
    resolve_user(cmd_create_reset, <span class="hljs-literal">false</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h3 id="load-a-password-reset-entry">Load a password reset entry</h3>
<p>Pattern: _<strong>role</strong>:user, <strong>cmd</strong>:load<em>reset</em>
Load a <em>sys/reset</em> entry by reset token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({role: role, cmd: <span class="hljs-string">'load_reset'</span>},
    cmd_load_reset)</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h3 id="execute-a-password-reset">Execute a password reset</h3>
<p>Pattern: _<strong>role</strong>:user, <strong>cmd</strong>:execute<em>reset</em>
Execute a <em>sys/reset</em> entry by reset token, providing the new password.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({role: role, cmd: <span class="hljs-string">'execute_reset'</span>},
    cmd_execute_reset)</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h3 id="update-user-details">Update user details</h3>
<p>Pattern: <em><strong>role</strong>:user, <strong>cmd</strong>:update</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({role: role, cmd: <span class="hljs-string">'update'</span>},
    cmd_update)</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h3 id="enable-user-deprecated">Enable User - DEPRECATED</h3>
<p>Replaced with <strong>activate</strong> command</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({role: role, cmd: <span class="hljs-string">'enable'</span>},<span class="hljs-comment">// keep this for backward compatibility</span>
    cmd_enable)</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h3 id="activate-user">Activate user</h3>
<p>Pattern: <em><strong>role</strong>:user, <strong>cmd</strong>:activate</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({role: role, cmd: <span class="hljs-string">'activate'</span>},
    cmd_enable)</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h3 id="disable-user-deprecated">Disable User - DEPRECATED</h3>
<p>Replaced with <strong>deactivate</strong> command</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({role: role, cmd: <span class="hljs-string">'disable'</span>},<span class="hljs-comment">// keep this for backward compatibility</span>
    cmd_disable)</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h3 id="deactivate-user">Deactivate user</h3>
<p>Pattern: <em><strong>role</strong>:user, <strong>cmd</strong>:deactivate</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({role: role, cmd: <span class="hljs-string">'deactivate'</span>},
    cmd_disable)</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h3 id="delete-user-deprecated">Delete User - DEPRECATED</h3>
<p>Replaced with <strong>remove</strong> command</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({role: role, cmd: <span class="hljs-string">'delete'</span>},<span class="hljs-comment">// keep this for backward compatibility</span>
    cmd_delete)</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h3 id="remove-user">Remove user</h3>
<p>Pattern: <em><strong>role</strong>:user, <strong>cmd</strong>:remove</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({role: role, cmd: <span class="hljs-string">'remove'</span>},
    cmd_delete)</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h3 id="deprecated">DEPRECATED</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.add({role: role, cmd: <span class="hljs-string">'entity'</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> loginent = seneca.make(login_canon)

    <span class="hljs-keyword">var</span> kind = args.kind || <span class="hljs-string">'user'</span>
    <span class="hljs-keyword">var</span> ent = (<span class="hljs-string">'user'</span> === kind ? seneca.make(user_canon) : loginent).make$()
    done(<span class="hljs-literal">null</span>, ent)
  })</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Action Implementations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_load_user</span> (<span class="hljs-params">args, done</span>) </span>{
    seneca.make(user_canon).load$(_.omit(args, [<span class="hljs-string">'role'</span>, <span class="hljs-string">'get'</span>]), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err)
      <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">true</span>, user: user})
    })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve_user</span> (<span class="hljs-params">cmd, fail</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args, done</span>) </span>{
      <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
      <span class="hljs-keyword">var</span> userent = seneca.make(user_canon)

      <span class="hljs-keyword">if</span> (args.user &amp;&amp; args.user.entity$) {
        <span class="hljs-keyword">return</span> cmd.call(seneca, args, done)
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> q = {}
        <span class="hljs-keyword">var</span> valid = <span class="hljs-literal">false</span>


        <span class="hljs-keyword">if</span> (args.email &amp;&amp; args.nick) {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>email wins</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (args.email !== args.nick) {
            q.email = args.email
            valid = <span class="hljs-literal">true</span>
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (~args.email.indexOf(<span class="hljs-string">'@'</span>)) {
            q.email = args.email
            valid = <span class="hljs-literal">true</span>
          }
          <span class="hljs-keyword">else</span> {
            q.nick = args.nick
            valid = <span class="hljs-literal">true</span>
          }
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args.email) {
          q.email = args.email
          valid = <span class="hljs-literal">true</span>
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args.nick) {
          q.nick = args.nick
          valid = <span class="hljs-literal">true</span>
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args.username) {
          q.nick = args.username
          valid = <span class="hljs-literal">true</span>
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args.user &amp;&amp; !args.user.entity$) {
          q.id = args.user
          valid = <span class="hljs-literal">true</span>
        }

        <span class="hljs-keyword">if</span> (!valid) {
          <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: <span class="hljs-string">'nick_or_email_missing'</span>})
        }

        userent.load$(q, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
          <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err)
          <span class="hljs-keyword">if</span> (!user) {
            <span class="hljs-keyword">if</span> (fail) {
              <span class="hljs-keyword">return</span> done(Eraro(seneca.fail(<span class="hljs-string">'user/not-found'</span>, q)))
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: <span class="hljs-string">'user-not-found'</span>, nick: q.nick, email: q.email})
          }
          args.user = user

          <span class="hljs-keyword">return</span> cmd.call(seneca, args, done)
        })
      }
    }
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hide</span> (<span class="hljs-params">args, propnames</span>) </span>{
    <span class="hljs-keyword">var</span> outargs = _.extend({}, args)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> pn <span class="hljs-keyword">in</span> propnames) {
      outargs[pn] = <span class="hljs-string">'[HIDDEN]'</span>
    }
    <span class="hljs-keyword">return</span> outargs
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasher</span> (<span class="hljs-params">src, rounds, done</span>) </span>{
    <span class="hljs-keyword">var</span> out = src
    <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>don’t chew up the CPU</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">round</span> (<span class="hljs-params"></span>) </span>{
      i++
      <span class="hljs-keyword">var</span> shasum = Crypto.createHash(<span class="hljs-string">'sha512'</span>)
      shasum.update(out, <span class="hljs-string">'utf8'</span>)
      out = shasum.digest(<span class="hljs-string">'hex'</span>)
      <span class="hljs-keyword">if</span> (rounds &lt;= i) {
        <span class="hljs-keyword">return</span> done(out)
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> === i % <span class="hljs-number">88</span>) {
        <span class="hljs-keyword">return</span> process.nextTick(round)
      }
      round()
    }

    round()
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Encrypt password using a salt and multiple SHA512 rounds
Override for password strength checking</p>
<ul>
<li>password: password string</li>
<li>repeat: password repeat, optional
Provides: {pass:,salt:,ok:,why:}
use why if password too weak</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_encrypt_password</span> (<span class="hljs-params">args, done</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>128 bits of salt</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> salt = args.salt || create_salt()
    <span class="hljs-keyword">var</span> password = args.password

    hasher(password + salt, options.rounds, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">pass</span>) </span>{
      done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">true</span>, pass: pass, salt: salt})
    })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">prepare_password_data</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> password = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> === args.password ? args.pass : args.password
    <span class="hljs-keyword">var</span> repeat = args.repeat

    <span class="hljs-keyword">if</span> (_.isUndefined(password)) {
      <span class="hljs-keyword">if</span> (options.autopass) {
        password = Uuid()
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, code: <span class="hljs-string">'user/no-password'</span>, whence: args.whence})
    }

    <span class="hljs-keyword">if</span> (_.isUndefined(repeat)) {
      <span class="hljs-keyword">if</span> (options.mustrepeat) {
        <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, code: <span class="hljs-string">'user/no-password-repeat'</span>, whence: args.whence})
      }
      <span class="hljs-keyword">else</span> repeat = password
    }

    <span class="hljs-keyword">if</span> (password !== repeat) {
      <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: <span class="hljs-string">'password_mismatch'</span>, whence: args.whence})
    }

    seneca.act(<span class="hljs-string">'role: '</span> + role + <span class="hljs-string">', cmd: encrypt_password'</span>, {password: password, salt: args.salt}, done)
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create_salt</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> Crypto.randomBytes(<span class="hljs-number">16</span>).toString(<span class="hljs-string">'ascii'</span>)
  }

  cmd_encrypt_password.descdata = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
    <span class="hljs-keyword">return</span> hide(args, {password: <span class="hljs-number">1</span>, repeat: <span class="hljs-number">1</span>})
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Verify proposed password is correct, redoing SHA512 rounds</p>
<ul>
<li>proposed: trial password string</li>
<li>pass:     password hash</li>
<li>salt:     password salt
Provides: {ok:}</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_verify_password</span> (<span class="hljs-params">args, done</span>) </span>{
    seneca.act(
      { role: role, cmd: <span class="hljs-string">'encrypt_password'</span>, whence: <span class="hljs-string">'verify_password/user='</span> + user.id + <span class="hljs-string">','</span> + user.nick,
        password: args.proposed, salt: args.salt },
      <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, out</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
          <span class="hljs-keyword">return</span> done(err)
        }
        <span class="hljs-keyword">if</span> (!out.ok) {
          <span class="hljs-keyword">return</span> done(err, out)
        }

        <span class="hljs-keyword">var</span> pass = out.pass

        <span class="hljs-keyword">var</span> ok = (pass === args.pass)</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>for backwards compatibility with &lt;= 0.2.3</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!ok &amp;&amp; options.oldsha) {
          <span class="hljs-keyword">var</span> shasum = Crypto.createHash(<span class="hljs-string">'sha1'</span>)
          shasum.update(args.proposed + args.salt)
          pass = shasum.digest(<span class="hljs-string">'hex'</span>)

          ok = (pass === args.pass)
          <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: ok})
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: ok})
      }
    )
  }

  cmd_verify_password.descdata = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
    <span class="hljs-keyword">return</span> hide(args, {proposed: <span class="hljs-number">1</span>})
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Change password using user’s nick or email</p>
<ul>
<li>nick, email: to resolve user</li>
<li>user: user entity</li>
<li>password: new password</li>
<li>repeat: password repeat, optional
Provides: {ok:,user:}</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_change_password</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> user = args.user

    seneca.act(
      { role: role, cmd: <span class="hljs-string">'encrypt_password'</span>, whence: <span class="hljs-string">'change/user='</span> + user.id + <span class="hljs-string">','</span> + user.nick,
        password: args.password, repeat: args.repeat, salt: args.salt },
      <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, out</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
          <span class="hljs-keyword">return</span> done(err)
        }
        <span class="hljs-keyword">if</span> (!out.ok) {
          <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, out)
        }

        user.salt = out.salt
        user.pass = out.pass
        user.save$(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
          <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-keyword">return</span> done(err)
          }

          user = user.data$(<span class="hljs-literal">false</span>)
          done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">true</span>, user: user})
        })
      })
  }

  cmd_change_password.descdata = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>{
    <span class="hljs-keyword">return</span> hide(args, {password: <span class="hljs-number">1</span>, repeat: <span class="hljs-number">1</span>})
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Register a new user</p>
<ul>
<li>nick:     username, data store should ensure unique, alias: username, email used if not present</li>
<li>email:    primary email address, data store should ensure unique</li>
<li>name:     full name of user</li>
<li>active:   status of user, active==true means login succeeds</li>
<li>password: password text, alias: pass</li>
<li>confirmed:  user already confirmed, default: false
Generated fields:</li>
<li>when: date and time of registration</li>
<li>confirmcode: used for confirmation
Provides:</li>
<li>success: {ok:true,user:}</li>
<li>failure: {ok:false,why:,nick:}</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_register</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> userent = seneca.make(user_canon)
    <span class="hljs-keyword">var</span> user = userent.make$()

    user.nick = args.nick || args.username || args.email
    user.email = args.email
    user.name = args.name || <span class="hljs-string">''</span>
    user.active = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> === args.active ? <span class="hljs-literal">true</span> : args.active
    user.when = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()

    <span class="hljs-keyword">if</span> (options.confirm) {
      user.confirmed = args.confirmed || <span class="hljs-literal">false</span>
      user.confirmcode = Uuid()
    }

    conditionalExtend(user, args)

    <span class="hljs-keyword">return</span> checknick(
      <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        checkemail(
          <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            saveuser()
          })
      })</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>unsafe nick unique check, data store should also enforce !!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checknick</span> (<span class="hljs-params">next</span>) </span>{
      <span class="hljs-keyword">if</span> (user.nick) {
        userent.load$({nick: user.nick}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, userfound</span>) </span>{
          <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err, {ok: <span class="hljs-literal">false</span>, user: user})
          <span class="hljs-keyword">if</span> (userfound) <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: <span class="hljs-string">'nick-exists'</span>, nick: args.nick})
          next()
        })
        <span class="hljs-keyword">return</span>
      }
      next()
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>unsafe email unique check, data store should also enforce !!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkemail</span> (<span class="hljs-params">next</span>) </span>{
      <span class="hljs-keyword">if</span> (user.email) {
        userent.load$({email: user.email}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, userfound</span>) </span>{
          <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err, {ok: <span class="hljs-literal">false</span>, user: user})
          <span class="hljs-keyword">if</span> (userfound) <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: <span class="hljs-string">'email-exists'</span>, nick: args.nick})
          next()
        })
        <span class="hljs-keyword">return</span>
      }
      next()
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">saveuser</span> (<span class="hljs-params"></span>) </span>{
      prepare_password_data(args, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, data</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
          <span class="hljs-keyword">return</span> done(err)
        }

        <span class="hljs-keyword">if</span> (!data.ok) {
          <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, data)
        }

        user.salt = data.salt
        user.pass = data.pass</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>before saving user some cleanup should be done</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cleanUser(user, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
          <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-keyword">return</span> done(err)
          }

          user.save$(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {
              <span class="hljs-keyword">return</span> done(err)
            }

            seneca.log.debug(<span class="hljs-string">'register'</span>, user.nick, user.email, user)
            done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">true</span>, user: user})
          })
        })
      })
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanUser</span> (<span class="hljs-params">user, done</span>) </span>{
    <span class="hljs-keyword">delete</span> user.repeat
    done(<span class="hljs-literal">null</span>, user)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Login an existing user - generates a login token. User must be active</p>
<ul>
<li>nick, email: to resolve user</li>
<li>user:     user entity</li>
<li>password: password text, alias: pass
Provides:</li>
<li>success: {ok:true,user:,login:}</li>
<li>failure: {ok:false,why:,nick:}</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_login</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> user = args.user
    <span class="hljs-keyword">var</span> why
    <span class="hljs-keyword">var</span> loginent = seneca.make(login_canon)


    <span class="hljs-keyword">if</span> (!user.active) {
      seneca.log.debug(<span class="hljs-string">'login/fail'</span>, why = <span class="hljs-string">'not-active'</span>, user)
      <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: why, user: user})
    }

    <span class="hljs-keyword">if</span> (args.auto) {
      <span class="hljs-keyword">return</span> make_login(user, <span class="hljs-string">'auto'</span>)
    }
    <span class="hljs-keyword">else</span> {
      seneca.act({role: role, cmd: <span class="hljs-string">'verify_password'</span>, proposed: args.password, pass: user.pass, salt: user.salt}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, out</span>) </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err)
        <span class="hljs-keyword">if</span> (!out.ok) {
          seneca.log.debug(<span class="hljs-string">'login/fail'</span>, why = <span class="hljs-string">'invalid-password'</span>, user)
          <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: why})
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> make_login(user, <span class="hljs-string">'password'</span>)
      })
    }


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_login</span> (<span class="hljs-params">user, why</span>) </span>{
      <span class="hljs-keyword">var</span> cleanargs = seneca.util.clean(_.clone(args))

      <span class="hljs-keyword">var</span> login = loginent.make$(seneca.util.argprops(
        {},
        cleanargs,
        {
          id$: Uuid(),
          nick: user.nick,
          user: user.id,
          when: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
          active: <span class="hljs-literal">true</span>,
          why: why
        },
        <span class="hljs-string">'role,cmd,password'</span>))

      login.token = login.id$ <span class="hljs-comment">// DEPRECATED</span>

      login.save$(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, login</span>) </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err)

        seneca.log.debug(<span class="hljs-string">'login/ok'</span>, why, user, login)
        done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">true</span>, user: user, login: login, why: why})
      })
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Confirm an existing user - using confirm code sent to user</p>
<ul>
<li>nick, email: to resolve user</li>
<li>code: confirmcode
Provides:</li>
<li>success: {ok:true,user:}</li>
<li>failure: {ok:false,why:,nick:}</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_confirm</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> why
    <span class="hljs-keyword">var</span> userent = seneca.make(user_canon)

    userent.load$({confirmcode: args.code}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err)

      <span class="hljs-keyword">if</span> (user) {
        <span class="hljs-keyword">if</span> (user.active) {
          user.confirmed = <span class="hljs-literal">true</span>
          user.save$(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
            <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err)
            done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">true</span>, user: user})
          })
        }
        <span class="hljs-keyword">else</span> {
          seneca.log.debug(<span class="hljs-string">'confirm/fail'</span>, why = <span class="hljs-string">'not-active'</span>, args.code, user)
          <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: why, user: user})
        }
      }
      <span class="hljs-keyword">else</span> {
        seneca.log.debug(<span class="hljs-string">'confirm/fail'</span>, why = <span class="hljs-string">'invalid-code'</span>, args.code, user)
        <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: why})
      }
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Authorize an existing user - resolve using token</p>
<ul>
<li>token:    login token
Provides:</li>
<li>success: {ok:true,user:,login:}</li>
<li>failure: {ok:false,why:,token:}</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_auth</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> userent = seneca.make(user_canon)
    <span class="hljs-keyword">var</span> loginent = seneca.make(login_canon)


    <span class="hljs-keyword">var</span> q = {id: args.token}

    loginent.load$(q, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, login</span>) </span>{
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err)

      <span class="hljs-keyword">if</span> (!login) {
        <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, token: args.token, why: <span class="hljs-string">'login-not-found'</span>})
      }

      userent.load$({id: login.user}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err)

        <span class="hljs-keyword">if</span> (!user) {
          <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, token: args.token, user: login.user, why: <span class="hljs-string">'user-not-found'</span>})
        }

        done(<span class="hljs-literal">null</span>, {user: user, login: login, ok: <span class="hljs-literal">true</span>})
      })
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Logout an existing user - resolve using token, idempotent</p>
<ul>
<li>token:    login token
Provides:</li>
<li>success: {ok:true,user:,login:}</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_logout</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> userent = seneca.make(user_canon)
    <span class="hljs-keyword">var</span> loginent = seneca.make(login_canon)


    <span class="hljs-keyword">var</span> q = {id: args.token}

    loginent.load$(q, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, login</span>) </span>{
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err)

      <span class="hljs-keyword">if</span> (!login) {
        <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">true</span>})
      }

      login.active = <span class="hljs-literal">false</span>
      login.ended = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime()
      login.save$(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, login</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
          <span class="hljs-keyword">return</span> done(err)
        }

        userent.load$({id: login.user}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
          <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-keyword">return</span> done(err)
          }

          seneca.log.debug(<span class="hljs-string">'logout'</span>, user, login)
          done(<span class="hljs-literal">null</span>, {user: user, login: login, ok: <span class="hljs-literal">true</span>})
        })
      })
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Create a password reset token</p>
<ul>
<li>nick, email: to resolve user</li>
<li>user:     user entity
Provides: {ok:,reset:,user:}</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_create_reset</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> user = args.user
    <span class="hljs-keyword">var</span> resetent = seneca.make(reset_canon)

    <span class="hljs-keyword">var</span> token = Uuid()

    resetent
    .make$({
      id$: token,
      token: token,
      nick: user.nick,
      user: user.id,
      when: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
      active: <span class="hljs-literal">true</span>
    })
    .save$(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, reset</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: err})
      }

      done(<span class="hljs-literal">null</span>, {reset: reset.data$(<span class="hljs-literal">false</span>), user: user.data$(<span class="hljs-literal">false</span>), ok: <span class="hljs-literal">true</span>})
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Load a password reset token</p>
<ul>
<li>token: reset token string
Provides: {ok:,reset:,user:}</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_load_reset</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> userent = seneca.make(user_canon)
    <span class="hljs-keyword">var</span> resetent = seneca.make(reset_canon)

    <span class="hljs-keyword">var</span> q = { token: args.token }

    resetent.load$(q, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, reset</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: err})
      }

      <span class="hljs-keyword">if</span> (!reset) {
        <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, token: args.token, why: <span class="hljs-string">'reset-not-found'</span>})
      }
      reset = reset.data$(<span class="hljs-literal">false</span>)

      userent.load$({id: reset.user}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
          <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: err})
        }

        <span class="hljs-keyword">if</span> (!user) {
          <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, token: args.token, user: reset.user, why: <span class="hljs-string">'user-not-found'</span>})
        }
        user = user.data$(<span class="hljs-literal">false</span>)

        done(<span class="hljs-literal">null</span>, {user: user, reset: reset, ok: <span class="hljs-literal">true</span>})
      })
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Execute a password change using a reset token</p>
<ul>
<li>token: reset token string</li>
<li>password: new password</li>
<li>repeat: password repeat, optional
Provides: {ok:,reset:,user:}</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_execute_reset</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> resetent = seneca.make(reset_canon)
    <span class="hljs-keyword">var</span> userent = seneca.make(user_canon)

    <span class="hljs-keyword">var</span> q = { id: args.token }

    resetent.load$(q, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, reset</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> done(err)
      }

      <span class="hljs-keyword">if</span> (!reset) {
        <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, token: args.token, why: <span class="hljs-string">'reset-not-found'</span>})
      }

      <span class="hljs-keyword">if</span> (!reset.active) {
        <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, token: args.token, why: <span class="hljs-string">'reset-not-active'</span>})
      }

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() &lt; <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(reset.when) + options.resetperiod) {
        <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, token: args.token, why: <span class="hljs-string">'reset-stale'</span>})
      }

      userent.load$({ id: reset.user }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
          <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, token: args.token, why: err})
        }

        <span class="hljs-keyword">if</span> (!user) {
          <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: <span class="hljs-string">'user-not-found'</span>})
        }

        seneca.act({ role: role, cmd: <span class="hljs-string">'change_password'</span>, user: user,
            password: args.password, repeat: args.repeat, salt: args.salt },
          <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, out</span>) </span>{
            <span class="hljs-keyword">if</span> (err) {
              <span class="hljs-keyword">return</span> done(err)
            }

            <span class="hljs-keyword">if</span> (!out.ok) {
              <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, out)
            }

            reset.active = <span class="hljs-literal">false</span>

            reset.save$(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, reset</span>) </span>{
              <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: err})
              }

              reset = reset.data$(<span class="hljs-literal">false</span>)
              user = user.data$(<span class="hljs-literal">false</span>)

              seneca.log.debug(<span class="hljs-string">'reset'</span>, reset.id, user.id, user.nick, user, reset)
              done(<span class="hljs-literal">null</span>, {user: user, reset: reset, ok: <span class="hljs-literal">true</span>})
            })
          })
      })
    })
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_delete</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> userent = seneca.make(user_canon)
    <span class="hljs-keyword">var</span> loginent = seneca.make(login_canon)
    <span class="hljs-keyword">var</span> resetent = seneca.make(reset_canon)

    <span class="hljs-keyword">var</span> user = userent.make$()

    <span class="hljs-keyword">var</span> q = {}

    <span class="hljs-keyword">if</span> (args.nick) {
      q.nick = args.nick
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args.email) {
      q.email = args.email
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> done({err: <span class="hljs-string">'cannot identify user to delete'</span>})
    }

    user.load$(q, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err, {ok: <span class="hljs-literal">false</span>})
      <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, exists: <span class="hljs-literal">false</span>})

      <span class="hljs-keyword">var</span> nick = user.nick
      q = {nick: nick}</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>delete from login</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> login = loginent.make$()
      login.remove$(q, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, data</span>) </span>{
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> seneca.log.warn(err)</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>delete now from resetent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> reset = resetent.make$()
        reset.remove$(q, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, data</span>) </span>{
          <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> seneca.log.warn(err)

          user.remove$(q, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, data</span>) </span>{
            <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err, {ok: <span class="hljs-literal">false</span>})
            done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">true</span>})
          })
        })
      })
    })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_update</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> userent = seneca.make(user_canon)

    <span class="hljs-keyword">var</span> user = userent.make$()

    <span class="hljs-keyword">var</span> q = {}

    args.orig_nick = args.orig_nick || args.nick
    <span class="hljs-keyword">if</span> (args.orig_nick) {
      q.nick = args.orig_nick
    }
    <span class="hljs-keyword">else</span> {
      q.email = args.orig_email || args.email
    }

    user.load$(q, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err, {ok: <span class="hljs-literal">false</span>, why: err})
      <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, exists: <span class="hljs-literal">false</span>})

      <span class="hljs-keyword">var</span> pwd = args.password || <span class="hljs-string">''</span>
      <span class="hljs-keyword">var</span> pwd2 = args.repeat || <span class="hljs-string">''</span>

      <span class="hljs-keyword">if</span> (pwd) {
        <span class="hljs-keyword">if</span> (pwd === pwd2 &amp;&amp; <span class="hljs-number">1</span> &lt; pwd.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>FIX: needs to a proper action call</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          cmd_change_password({nick: args.orig_nick, password: pwd}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, userpwd</span>) </span>{
            <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err, {ok: <span class="hljs-literal">false</span>, why: err})
            user = userpwd
          })
        }
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: <span class="hljs-string">'user/password_mismatch'</span>})
        }
      }

      <span class="hljs-keyword">delete</span> args.orig_nick
      <span class="hljs-keyword">delete</span> args.orig_email

      <span class="hljs-keyword">return</span> checknick(
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
          checkemail(
            <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
              updateuser(user)
            })
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>unsafe nick unique check, data store should also enforce !!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checknick</span> (<span class="hljs-params">next</span>) </span>{
        <span class="hljs-keyword">if</span> (args.nick) {
          userent.list$({nick: args.nick}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, users</span>) </span>{
            <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err, {ok: <span class="hljs-literal">false</span>, user: user})
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; users.length; i++) {
              <span class="hljs-keyword">var</span> each = users[i]
              <span class="hljs-keyword">if</span> (each.id !== user.id) {
                <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: <span class="hljs-string">'nick-exists'</span>, nick: args.nick})
              }
            }

            next()
          })
          <span class="hljs-keyword">return</span>
        }
        next()
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>unsafe email unique check, data store should also enforce !!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkemail</span> (<span class="hljs-params">next</span>) </span>{
        <span class="hljs-keyword">if</span> (args.email) {
          userent.list$({email: args.email}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, users</span>) </span>{
            <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err, {ok: <span class="hljs-literal">false</span>, user: user})
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; users.length; i++) {
              <span class="hljs-keyword">var</span> each = users[i]
              <span class="hljs-keyword">if</span> (each.id !== user.id) {
                <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: <span class="hljs-string">'email-exists'</span>, nick: args.nick})
              }
            }

            next()
          })
          <span class="hljs-keyword">return</span>
        }
        next()
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateuser</span> (<span class="hljs-params">pwdupdate</span>) </span>{
        user.nick = args.nick || pwdupdate.nick
        user.name = args.name || pwdupdate.name
        user.email = args.email || pwdupdate.email

        user.salt = pwdupdate.salt
        user.pass = pwdupdate.pass

        <span class="hljs-keyword">if</span> (<span class="hljs-string">''</span> === user.nick) {
          done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: <span class="hljs-string">'empty_nick'</span>})
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">''</span> === user.email) {
          done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: <span class="hljs-string">'empty_email'</span>})
        }
        <span class="hljs-keyword">else</span> {
          conditionalExtend(user, args)
          user.save$(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
            done(err, {ok: !err, user: user.data$(<span class="hljs-literal">false</span>)})
          })
        }
      }
    })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_disable</span> (<span class="hljs-params">args, done</span>) </span>{
    cmd_change_active.call(<span class="hljs-keyword">this</span>, args, <span class="hljs-literal">false</span>, done)
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_enable</span> (<span class="hljs-params">args, done</span>) </span>{
    cmd_change_active.call(<span class="hljs-keyword">this</span>, args, <span class="hljs-literal">true</span>, done)
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_change_active</span> (<span class="hljs-params">args, active, done</span>) </span>{
    <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> userent = seneca.make(user_canon)

    <span class="hljs-keyword">var</span> user = userent.make$()

    <span class="hljs-keyword">var</span> q = {}

    <span class="hljs-keyword">if</span> (args.nick) {
      q.nick = args.nick
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args.email) {
      q.email = args.email
    }

    <span class="hljs-keyword">if</span> (!q.nick &amp;&amp; !q.email) {
      <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, why: <span class="hljs-string">'cannot-identify-user'</span>})
    }

    user.load$(q, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> done(err, {ok: <span class="hljs-literal">false</span>})
      <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, {ok: <span class="hljs-literal">false</span>, exists: <span class="hljs-literal">false</span>})

      user.active = active
      user.save$(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, user</span>) </span>{
        done(err, {ok: !err, user: user})
      })
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>DEPRECATED - do this in seneca-auth</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmd_clean</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> user = args.user.data$()
    <span class="hljs-keyword">delete</span> user.pass
    <span class="hljs-keyword">delete</span> user.salt
    <span class="hljs-keyword">delete</span> user.active
    <span class="hljs-keyword">delete</span> user.$
    done(<span class="hljs-literal">null</span>, user)
  }


  seneca.add({init: role}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args, done</span>) </span>{
    <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> userent = seneca.make(user_canon)
    <span class="hljs-keyword">var</span> loginent = seneca.make(login_canon)
    <span class="hljs-keyword">var</span> resetent = seneca.make(reset_canon)

    <span class="hljs-keyword">this</span>.act(<span class="hljs-string">'role:util, cmd:define_sys_entity'</span>, {
      list: [
        { entity: userent.entity$, fields: options.user.fields },
        { entity: loginent.entity$, fields: options.login.fields },
        { entity: resetent.entity$, fields: options.reset.fields }
      ]
    }, done)
  })


  <span class="hljs-keyword">return</span> {
    name: role
  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
