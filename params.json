{"name":"Seneca-user","tagline":"seneca-user","body":"# seneca-user\r\n\r\n## A user management plugin for the [Seneca](http://senecajs.org) toolkit\r\n\r\nThis module is a plugin for the Seneca framework. It provides business logic for user management, such as:\r\n\r\n   * login\r\n   * logout\r\n   * registration\r\n   * password handling, incl. resets\r\n\r\nThere are two core concepts: user and login. A _user_, storing the user account details and encrypted passwords, \r\nand a _login_, representing an instance of a user that has been authenticated. A user can have multiple logins.\r\n\r\nThis module does not make any assumptions about the context it runs in. \r\nUse the [seneca-auth](http://github.com/rjrodger/seneca-auth) plugin to handle web and social media authentication.\r\n\r\nFor a working example, see the <a href=\"https://github.com/rjrodger/seneca-examples/tree/master/user-accounts\">Seneca user accounts example</a>.\r\n\r\n\r\n## Support\r\n\r\nIf you're using this module, feel free to contact me on Twitter if you\r\nhave any questions! :) [@rjrodger](http://twitter.com/rjrodger)\r\n\r\nCurrent Version: 0.2.7\r\n\r\nTested on: Node 0.10.24, Seneca 0.5.15\r\n\r\n[![Build Status](https://travis-ci.org/rjrodger/seneca-user.png?branch=master)](https://travis-ci.org/rjrodger/seneca-user)\r\n\r\n\r\n\r\n## Quick example\r\n\r\n```JavaScript\r\nvar seneca = require('seneca')()\r\nseneca.use('user')\r\n\r\nseneca.ready(function(){\r\n\r\n  var userpin = seneca.pin({role:'user',cmd:'*'})\r\n\r\n  userpin.register( {name:\"Flann O'Brien\",email:'nincompoop@deselby.com',password:'blackair'}, \r\n  function(err,out) {\r\n\r\n    userpin.login({email:'nincompoop@deselby.com',password:'bicycle'}, function(err,out){\r\n      console.log('login success: '+out.ok)\r\n\r\n      userpin.login({email:'nincompoop@deselby.com',password:'blackair'}, function(err,out){\r\n        console.log('login success: '+out.ok)\r\n        console.log('login instance: '+out.login)\r\n      })\r\n    })\r\n  })\r\n})\r\n```\r\n\r\nThis example, uses a _pin_ for convenience: <code>userpin.register( ... )</code> is the same as \r\n<code>seneca.act({role:'user',cmd:'register', ... )</code>.\r\n\r\nIn the example code, a user is registered, and then two login attempts are made. The first with an incorrect password, the second with the correct\r\npassword. The successful login provides a login instance. The _login.id_ property can be used to authenticate this login. For example,\r\nthe [seneca-auth](http://github.com/rjrodger/seneca-auth) plugin uses this token as a HTTP authentication cookie.\r\n\r\nTo run this example (and the other code in this README), try:\r\n\r\n```sh\r\nnode test/readme.js\r\n```\r\n\r\n\r\n## Deeper example\r\n\r\nTake a look at the <a href=\"http://github.com/rjrodger/seneca-examples\">user accounts example</a>.\r\n\r\n\r\n\r\n## Install\r\n\r\n```sh\r\nnpm install seneca\r\nnpm install seneca-user\r\n```\r\n\r\nYou'll need the [seneca](http://github.com/rjrodger/seneca) module to use this module - it's just a plugin.\r\n\r\n\r\n\r\n## Usage\r\n\r\nTo load the plugin:\r\n\r\n```JavaScript\r\nseneca.use('user', { ... options ... })\r\n```\r\n\r\nThe user and login data is persisted using Seneca entities. These have\r\nnames _sys/user_ and _sys/login_.\r\n\r\nPasswords are not stored in plaintext, but using an ~10k round salted SHA512 hash. In\r\nthe context of password reset functionality, this means you can\r\ngenerate new passwords, but cannot recover old ones. \r\n[This is what you want](http://www.codinghorror.com/blog/2007/09/youre-probably-storing-passwords-incorrectly.html).\r\n\r\nThere are separate actions to encrypt and verify passwords, so you can do things your own way if you like.\r\n\r\nTo support different use cases, users can be identified by either a\r\n_nick_ or their email address. The _nick_ property is the traditional\r\n'username', but does not need to be used in this fashion (hence the name 'nick').\r\n\r\nAll actions defined by this plugin return meta data objects containing the results of the action. The meta data object\r\ncontains an _ok_ field that is either true or false, indicating the success or failure of the action. For example, a login attempt with an invalid password will result in an <code>{ok:false,...}</code>. When relevant, a _why_ property is also provided, with a code that indicates the reason for the result. For example: {...,why:'user-not-found'}.\r\n\r\n\r\n\r\n## Options\r\n\r\n   * _rounds_: number of SHA512 rounds to use for password encryption, default: 11111\r\n   * _autopass_: automatically generate an (unrecoverable) password if none is supplied - mostly good for testing, default: true\r\n   * _mustrepeat_: you must provide a _repeat_ argument (a repeat of the password) when setting a password\r\n   * _resetperiod_: duration in millis that a password reset token is valid, default: 24 hours\r\n\r\nTo set options, do so when you load the plugin:\r\n\r\n```javascript\r\nseneca.use('user',{ resetperiod: 3600*1000 })\r\n```\r\n\r\n\r\n\r\n## Entities\r\n\r\n### User\r\n\r\nThe user entity has a default type of _-/sys/user_ and standard properties:\r\n\r\n   * _nick_: Username, mostly. If not provided, will be set to email value.\r\n   * _email_: Email address. At least one of nick or email is required.\r\n   * _name_: Name of user. Just a text field. [Cultural imperialism damages your conversions, ya know...](http://www.kalzumeus.com/2010/06/17/falsehoods-programmers-believe-about-names/)!\r\n   * _active_: if true, user can log in, if false, user can't. Default: true.\r\n   * _when_: creation time, ISO String, like 2013-03-21T17:32:24.039Z\r\n   * _salt_: salt for encrypted password\r\n   * _pass_: encrypted password\r\n\r\nYou can add your own properties, but be careful not to use the standard property names.\r\n\r\n\r\n### Login\r\n\r\nThe login entity has a default type of _-/sys/login_ and standard properties:\r\n\r\n   * _id_: authentication token, UUID\r\n   * _nick_: copied from user\r\n   * _user_: user.id string\r\n   * _when_: creation time, ISO String, like 2013-03-21T17:32:24.039Z\r\n   * _active_: if true, login against this token will succeed, otherwise not\r\n\r\nYou can add your own properties, but be careful not to use the standard property names.\r\n\r\n\r\n### Reset\r\n\r\nThe reset entity has a default type of _-/sys/reset_ and standard properties:\r\n\r\n   * _id_: authentication token, UUID\r\n   * _nick_: copied from user\r\n   * _user_: user.id string\r\n   * _when_: creation time, ISO String, like 2013-03-21T17:32:24.039Z\r\n   * _active_: if true, reset against this token will succeed, otherwise not\r\n\r\nYou can add your own properties, but be careful not to use the standard property names.\r\n\r\n\r\n\r\n## Actions\r\n\r\nAll actions provide results via the standard callback format: <code>function(error,data){ ... }</code>.\r\n\r\nTo customize the behavior of the plugin, override these actions, and provide your own business logic. You call call _this.prior_\r\ninside each custom action to perform the default behaviour - see the [Customization] section below.\r\n\r\n\r\n### role:user, cmd:login\r\n\r\nLogin an existing user. Creates a new sys_login entry.\r\n\r\n#### Arguments:\r\n   \r\n   * _nick_: required if no email, identifies user, alias: username\r\n   * _email_: required if no nick, identifies user\r\n   * _password_: password as entered by user, optional if using _auto_\r\n   * _auto_: automatic login without password, default: _false_. Use this to generate login tokens.\r\n   * _user_: specify user using a sys/user entity - for convenience use inside your own actions, when you already have a user entity loaded\r\n\r\n#### Provides:\r\n\r\nObject with properties:\r\n\r\n   * _ok_: true if login succeeded, false if not\r\n   * _login_: login entity, id is the login token, used as cookie\r\n   * _user_: user entity\r\n   * _why_: indicates reason login failed or succeeded, refer to [source](https://github.com/rjrodger/seneca-user/blob/master/lib/user.js) for codes.\r\n\r\n\r\n\r\n### role:user, cmd:logout\r\n\r\nLogout a user. Update _sys/login_ entry to _active:false_. Adds _ended_ field with ISOString date time.  \r\n\r\n#### Arguments:\r\n   \r\n   * _token_: existing login token, maybe from a cookie\r\n\r\n#### Provides:\r\n\r\nSame object format as login command result: {ok:true|false,user:,login:}\r\n\r\n\r\n\r\n### role:user, cmd:register\r\n\r\nRegister a new user. You'll probably call this after a user fills out\r\na regstration form. Any additional action arguments are saved as user\r\nproperties. The nick and email fields will be checked for\r\nuniqueness. The new user is not logged in, use the login action for\r\nthat.\r\n\r\n\r\n#### Arguments:\r\n   \r\n   * _nick_: Username, mostly. If not provided, will be set to args.username value, if defined, otherwise args.email value.\r\n   * _email_: Email address. At least one of nick or email is required.\r\n   * _username_: a convenience - just an alias for nick.\r\n   * _password_: Plaintext password, supplied by user - will be stored encrypted and unrecoverable.\r\n   * _repeat_: Password, repeated. Optional - if provided, must match password.\r\n   * _name_: Name of user. Just a text field.\r\n   * _active_: if true, user can log in, if false, user can't. Default: true.\r\n\r\n#### Provides:\r\n\r\nObject with properties:\r\n\r\n   * _ok_: true if registration succeeded, false if not\r\n   * _user_: new user entity\r\n   * _why_: indicates reason registration failed, refer to [source](https://github.com/rjrodger/seneca-user/blob/master/lib/user.js) for codes.\r\n\r\n\r\n\r\n### role:user, cmd:auth\r\n\r\nAuthenticate a login token, returning the associated _sys/login_ and _sys/user_ if\r\nthe token is valid and active. Use this, for example, when handling\r\nHTTP requests with an authentication cookie, to get the user.\r\n\r\n\r\n#### Arguments:\r\n   \r\n   * _token_: existing login token, maybe from a cookie\r\n\r\n#### Provides:\r\n\r\nSame object format as login command result: {ok:true|false,user:,login:}\r\n\r\n\r\n\r\n### role:user, cmd:create_reset\r\n\r\nCreate a reset token, valid for a 24 hours (use the _resetperiod_ options to alter the validity period). This action\r\ncreates an entry in the _sys/reset_ collection.\r\n\r\n\r\n#### Arguments:\r\n\r\n   * _nick_: required if no email, identifies user, alias: username\r\n   * _email_: required if no nick, identifies user\r\n   * _user_: specify user using a sys/user entity - for convenience use inside your own actions, when you already have a user entity loaded\r\n   \r\n#### Provides:\r\n\r\nObject with properties:\r\n\r\n   * _ok_: true if update succeeded, false if not\r\n   * _user_: _sys/user_ entity\r\n   * _reset_: _sys/reset_ entity\r\n\r\n\r\n### role:user, cmd:load_reset\r\n\r\nLoad a _sys/reset_ entity using a reset token. Use this to load the details of a reset request, possible to confirm with user.\r\n\r\n\r\n#### Arguments:\r\n\r\n   * _token_: reset token\r\n   \r\n#### Provides:\r\n\r\nObject with properties:\r\n\r\n   * _ok_: true if reset found, false if not\r\n   * _user_: _sys/user_ entity\r\n   * _reset_: _sys/reset_ entity\r\n   * _why_: reason for failure\r\n\r\n\r\n### role:user, cmd:execute_reset\r\n\r\nExecute a password reset action. The user identified by the reset token is allowed to change their password. THe reset must be active, and the validity period must not be expired. On successful reset, the _sys/reset_ is deactivated and cannot be reused.\r\n\r\n\r\n#### Arguments:\r\n\r\n   * _token_: reset token\r\n   * _password_: new password\r\n   * _repeat_: optional, repeat of new password\r\n   \r\n#### Provides:\r\n\r\nObject with properties:\r\n\r\n   * _ok_: true if reset found, false if not\r\n   * _user_: _sys/user_ entity\r\n   * _reset_: _sys/reset_ entity\r\n   * _why_: reason for failure\r\n\r\n\r\n\r\n### role:user, cmd:encrypt_password\r\n\r\nEncrypts a plaintext password, providing the salt and ciphertext. The encyption is _options.rounds_ (default:11111) rounds of SHA512.\r\n\r\n#### Arguments:\r\n   \r\n   * _password_: plaintext password.\r\n   * _repeat_: optional, repeat of password\r\n\r\n#### Provides:\r\n\r\nObject with properties:\r\n\r\n   * _ok_: true if succeeded\r\n   * _salt_: the salt string\r\n   * _pass_: the ciphertext string\r\n   * _why_: reason for failure\r\n\r\n\r\n### role:user, cmd:verify_password\r\n\r\nVerifies that a password matches a given salt and ciphertext.\r\n\r\n#### Arguments:\r\n   \r\n   * _salt_: the salt string to use, find this in user.salt\r\n   * _pass_: the pass string to use, find this in user.pass\r\n   * _proposed_: the proposed plaintext password to verify\r\n\r\n#### Provides:\r\n\r\nObject with properties:\r\n\r\n   * _ok_: true if password matches\r\n\r\n### role:user, cmd:update\r\n\r\nUpdates a user.\r\n\r\n#### Arguments:\r\n   \r\n   * nick: the nick of the user to be updated\r\n   * orig_nick: if nick will be changed on this update then orig_nick will be used to identify the user\r\n   * email: the email of the user to be updated\r\n   * orig_email: if email will be changed on this update then orig_email will be used to identify the user\r\n   * \r\nAt least one of these arguments must be present.\r\n\r\n#### Provides:\r\n\r\nObject with properties:\r\n\r\n   * _ok_: true if operation is OK\r\n\r\n### role:user, cmd:delete\r\n\r\nDeletes an user and all relationed records.\r\n\r\n#### Arguments:\r\n   \r\n   * nick: the nick of the user to be updated\r\n\r\n#### Provides:\r\n\r\nObject with properties:\r\n\r\n   * _ok_: true if operation is OK\r\n\r\n\r\n### role:user, cmd:enable\r\n\r\nEnables an user.\r\n\r\n#### Arguments:\r\n\r\n   * nick: the nick of the user to be updated\r\n   * email: the email of the user to be updated\r\n\r\nAt least one of these arguments must be present\r\n\r\n#### Provides:\r\n\r\nObject with properties:\r\n\r\n   * _ok_: true if operation is OK\r\n\r\n### role:user, cmd:disable\r\n\r\nDisables an user.\r\n\r\n#### Arguments:\r\n\r\n   * nick: the nick of the user to be updated\r\n   * email: the email of the user to be updated\r\n\r\nAt least one of these arguments must be present\r\n\r\n#### Provides:\r\n\r\nObject with properties:\r\n\r\n   * _ok_: true if operation is OK\r\n\r\n\r\n\r\n\r\n\r\n## Logging\r\n\r\nTo see what this plugin is doing, try:\r\n\r\n```sh\r\nnode your-app.js --seneca.log=plugin:user\r\n```\r\n\r\nThis will print action logs and plugin logs for the user plugin. To skip the action logs, use:\r\n\r\n```sh\r\nnode your-app.js --seneca.log=type:plugin,plugin:user\r\n```\r\n\r\nYou can also set up the logging programmatically:\r\n\r\n    var seneca = require('seneca')({\r\n      log:{\r\n        map:[\r\n          {plugin:'user',handler:'print'}\r\n        ]\r\n      }\r\n    })\r\n\r\nFor more on logging, see the [seneca logging example](http://senecajs.org/logging-example.html).\r\n\r\n\r\n\r\n\r\n### Customization\r\n\r\nAs with all seneca plugins, you can customize behavior simply by overwriting actions.\r\n\r\nFor example, to add some custom fields when registering a user:\r\n\r\n\r\n```javascript\r\n    // override by using the same action pattern\r\n    seneca.add({role:'user',cmd:'register'},function(args,done){\r\n    \r\n      // assign user to one of 10 random \"teams\"\r\n      args.team = Math.floor( 10 * Math.random() )\r\n    \r\n      // this calls the original action, as provided by the user plugin\r\n      this.parent(args,done)\r\n    })\r\n    \r\n    \r\n    userpin.register( {name:\"Brian O'Nolan\",email:'brian@swim-two-birds.com',password:'na-gCopaleen'}, \r\n    function(err,out) {\r\n      console.log('user has team: '+out.user.team)\r\n    })\r\n```\r\n\r\n\r\n## Test\r\n\r\n```sh\r\ncd test\r\nmocha user.test.js --seneca.log.print\r\n```\r\n\r\n\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}